# 移动端客户端测试指南

## 测试前准备

### 1. 启动服务端

```bash
cd server
npm run dev
```

等待看到公网 URL：
```
🌐 Public URL (Tunnel):
   https://xxxx-xxxx.trycloudflare.com/ws
```

### 2. 安装 Expo Go

在手机上下载并安装 **Expo Go** 应用（App Store 或 Google Play）

---

## 本地回环测试

### 步骤

1. **在电脑上启动客户端**
   ```bash
   cd client
   npm run web
   ```

2. **在浏览器中打开**
   - 会自动打开 http://localhost:8081
   - 应该看到连接配置页面

3. **输入本地 URL**
   - 输入：`ws://localhost:3000`
   - 点击"连接"按钮

4. **验证连接**
   - 状态指示器应变为 🟢
   - 自动跳转到聊天页面

5. **发送测试消息**
   - 输入："你好，测试"
   - 点击发送
   - 预期 1-2 秒后收到 Echo 回复

---

## 局域网测试

### 步骤

1. **获取电脑 IP 地址**
   - macOS: 系统设置 → 网络 → 查看本机 IP
   - 例如：`192.168.1.100`

2. **手机连接同一 WiFi**
   - 确保手机和电脑在同一 WiFi 下

3. **手机上打开 Expo Go**
   - 扫描终端显示的二维码
   - 或手动输入地址

4. **输入局域网 URL**
   - 输入：`ws://192.168.1.100:3000`
   - 点击"连接"

5. **发送测试消息**
   - 验证消息收发正常

---

## 公网穿透测试

### 步骤

1. **获取公网 URL**
   - 从服务端日志复制：
     ```
     https://pairs-vic-pci-labels.trycloudflare.com
     ```

2. **手机上操作**
   - 打开 Expo Go 应用
   - 扫描服务端显示的二维码
   - 或手动输入地址

3. **输入公网 URL**
   - 输入：`https://pairs-vic-pci-labels.trycloudflare.com/ws`
   - 点击"连接"
   - 系统会自动转换为：`wss://pairs-vic-pci-labels.trycloudflare.com`

4. **关闭 WiFi（可选）**
   - 手机关闭 WiFi
   - 只使用 4G/5G
   - 验证公网连接

5. **发送测试消息**
   - 发送："测试公网连接"
   - 观察延迟和稳定性

---

## 功能测试清单

### 连接管理
- [ ] 能成功连接到服务端
- [ ] 连接状态正确显示（🟢🔴🟡）
- [ ] 断线后自动重连
- [ ] 重连使用指数退避策略

### 消息收发
- [ ] 能发送用户消息
- [ ] 能收到 AI Echo 回复
- [ ] 消息按时间正确排序
- [ ] 用户/AI 消息样式区分

### 心跳机制
- [ ] 每 30 秒发送心跳
- [ ] RTT 延迟正确显示
- [ ] RTT 颜色等级正确（<100ms 绿色，100-300ms 黄色，>300ms 红色）
- [ ] 心跳超时能触发重连

### 历史记录
- [ ] 保存最近连接 URL（最多 5 个）
- [ ] 能点击历史快速连接
- [ ] 能删除单个历史记录
- [ ] 能清空所有历史

### 用户体验
- [ ] URL 自动格式化
- [ ] 一键粘贴功能
- [ ] 连接成功自动跳转聊天页面
- [ ] 输入框在断线时禁用

---

## 性能测试

### 延迟测试
- 本地连接：RTT < 50ms
- 局域网：RTT < 100ms
- 公网连接：RTT 100-500ms

### 稳定性测试
- 连续发送 10 条消息
- 观察消息顺序
- 检查是否有丢包

### 重连测试
- 手动停止服务端
- 观察重连行为
- 重启服务端后验证自动恢复

---

## 常见问题

### 连接失败

**问题**: 点击"连接"后提示"连接失败"
- 检查 URL 格式是否正确
- 检查服务端是否运行
- 检查网络连接

### 消息无回复

**问题**: 发送消息后没有收到 Echo
- 检查连接状态
- 查看服务端日志
- 验证网络稳定性

### 高延迟

**问题**: RTT 显示 > 500ms
- 检查网络质量
- 公网连接时检查 Tunnel 状态
- 尝试切换网络（WiFi ↔ 4G/5G）

---

## 调试技巧

### 查看日志

**Web 浏览器**
- 打开开发者工具（F12）
- 查看 Console 输出

**Expo Go**
- 打开应用日志
- 查看 WebSocket 相关日志

### 网络抓包

可以使用 Chrome DevTools 抓包查看 WebSocket 帧：
1. 连接应用
2. 打开 Chrome DevTools
3. Network → WS 标签
4. 查看 WebSocket 帧

---

## 成功标准

测试通过的标准：
- ✅ 所有连接方式（本地/局域网/公网）都能正常工作
- ✅ 消息收发正常，Echo 回复正确
- ✅ 心跳机制正常，RTT 计算准确
- ✅ 自动重连机制工作正常
- ✅ 用户体验流畅，无明显卡顿
